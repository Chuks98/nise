// Date formatter

function formatDate(dateString) {
  const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', options);
}




/*
Template Name: Admin Template
Author: Wrappixel

File: js
*/
// ==============================================================
// Auto select left navbar
// ==============================================================

// Sidebar menu JavaScript codes

$(function () {
  "use strict";
  var url = window.location + "";
  var path = url.replace(
    window.location.protocol + "//" + window.location.host + "/",
    ""
  );
  var element = $("ul#sidebarnav a").filter(function () {
    return this.href === url || this.href === path; // || url.href.indexOf(this.href) === 0;
  });

  function findMatchingElement() {
    var currentUrl = window.location.href;
    var anchors = document.querySelectorAll("#sidebarnav a");
    for (var i = 0; i < anchors.length; i++) {
      if (anchors[i].href === currentUrl) {
        return anchors[i];
      }
    }

    return null; // Return null if no matching element is found
  }
  var elements = findMatchingElement();

  // Do something with the matching element
  if(elements){
    elements.classList.add("active");
  }

  document
    .querySelectorAll("ul#sidebarnav ul li a.active")
    .forEach(function (link) {
      link.closest("ul").classList.add("in");
      link.closest("ul").parentElement.classList.add("selected");
    });

  document.querySelectorAll("#sidebarnav li").forEach(function (li) {
    const isActive = li.classList.contains("selected");
    if (isActive) {
      const anchor = li.querySelector("a");
      if (anchor) {
        anchor.classList.add("active");
      }
    }
  });

  document.querySelectorAll("#sidebarnav a").forEach(function (link) {
    link.addEventListener("click", function (e) {
      const isActive = this.classList.contains("active");
      const parentUl = this.closest("ul");
      if (!isActive) {
        // hide any open menus and remove all other classes
        parentUl.querySelectorAll("ul").forEach(function (submenu) {
          submenu.classList.remove("in");
        });
        parentUl.querySelectorAll("a").forEach(function (navLink) {
          navLink.classList.remove("active");
        });

        // open our new menu and add the open class
        const submenu = this.nextElementSibling;
        if (submenu) {
          submenu.classList.add("in");
        }

        this.classList.add("active");
      } else {
        this.classList.remove("active");
        parentUl.classList.remove("active");
        const submenu = this.nextElementSibling;
        if (submenu) {
          submenu.classList.remove("in");
        }
      }
    });
  });

});









$(function () {
  // Admin Panel settings

  //****************************
  /* This is for the mini-sidebar if width is less then 1170*/
  //****************************
  var setsidebartype = function () {
    var width =
      window.innerWidth > 0 ? window.innerWidth : this.screen.width;
    if (width < 1199) {
      $("#main-wrapper").attr("data-sidebartype", "mini-sidebar");
      $("#main-wrapper").addClass("mini-sidebar");
    } else {
      $("#main-wrapper").attr("data-sidebartype", "full");
      $("#main-wrapper").removeClass("mini-sidebar");
    }
  };
  $(window).ready(setsidebartype);
  $(window).on("resize", setsidebartype);
  //****************************
  /* This is for sidebartoggler*/
  //****************************
  $(".sidebartoggler").on("click", function () {
    $("#main-wrapper").toggleClass("mini-sidebar");
    if ($("#main-wrapper").hasClass("mini-sidebar")) {
      $(".sidebartoggler").prop("checked", !0);
      $("#main-wrapper").attr("data-sidebartype", "mini-sidebar");
    } else {
      $(".sidebartoggler").prop("checked", !1);
      $("#main-wrapper").attr("data-sidebartype", "full");
    }
  });
  $(".sidebartoggler").on("click", function () {
    $("#main-wrapper").toggleClass("show-sidebar");
  });








  // General dashboard JS 

  $(function () {


  // -----------------------------------------------------------------------
  // sales overview
  // -----------------------------------------------------------------------

  var options_sales_overview = {
    series: [
      {
        name: "Ample Admin",
        data: [355, 390, 300, 350, 390, 180],
      },
      {
        name: "Pixel Admin",
        data: [280, 250, 325, 215, 250, 310],
      },
    ],
    chart: {
      type: "bar",
      height: 275,
      toolbar: {
        show: false,
      },
      foreColor: "#adb0bb",
      fontFamily: "inherit",
      sparkline: {
        enabled: false,
      },
    },
    grid: {
      show: false,
      borderColor: "transparent",
      padding: {
        left: 0,
        right: 0,
        bottom: 0,
      },
    },
    plotOptions: {
      bar: {
        horizontal: false,
        columnWidth: "25%",
        endingShape: "rounded",
        borderRadius: 5,
      },
    },
    colors: ["var(--bs-primary)", "var(--bs-secondary)"],
    dataLabels: {
      enabled: false,
    },
    yaxis: {
      show: true,
      min: 100,
      max: 400,
      tickAmount: 3,
    },
    stroke: {
      show: true,
      width: 5,
      lineCap: "butt",
      colors: ["transparent"],
    },
    xaxis: {
      type: "category",
      categories: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
      axisBorder: {
        show: false,
      },
    },
    fill: {
      opacity: 1,
    },
    tooltip: {
      theme: "dark",
    },
    legend: {
      show: false,
    },
  };

  var chart_column_basic = new ApexCharts(
    document.querySelector("#sales-overview"),
    options_sales_overview
  );
  chart_column_basic.render();


});











// Student/user registration javascript codes
$(() => {
  if (window.location.pathname === '/student-registration') {
    // Toggle password visibility
    $("#togglePassword").on("click", function () {
        let input = $("#password");
        let icon = $(this).find("i");

        if (input.attr("type") === "password") {
            input.attr("type", "text");
            icon.removeClass("ti-eye").addClass("ti-eye-off");
        } else {
            input.attr("type", "password");
            icon.removeClass("ti-eye-off").addClass("ti-eye");
        }
    });

    // Toggle Confirm Password
    $("#toggleConfirmPassword").on("click", function () {
        let input = $("#confirmPassword");
        let icon = $(this).find("i");

        if (input.attr("type") === "password") {
            input.attr("type", "text");
            icon.removeClass("ti-eye").addClass("ti-eye-off");
        } else {
            input.attr("type", "password");
            icon.removeClass("ti-eye-off").addClass("ti-eye");
        }
    });


    // LIVE PASSWORD STRENGTH CHECK
    $('#password').on('input', function () {
        let password = $(this).val();
        let feedback = $('#passwordStrength');

        // Check strength: must contain letters + numbers
        let hasLetter = /[a-zA-Z]/.test(password);
        let hasNumber = /\d/.test(password);

        if (password.length < 6) {
            feedback.text("Password must be at least 6 characters").css("color", "red");
        } 
        else if (!hasLetter || !hasNumber) {
            feedback.text("Password must contain letters and numbers").css("color", "red");
        } 
        else {
            feedback.text("Strong password ‚úî").css("color", "green");
        }
    });

    // LIVE PASSWORD MATCH CHECK
    $('#password, #confirmPassword').on('input', function () {
        let password = $('#password').val();
        let confirmPassword = $('#confirmPassword').val();
        let feedback = $('#passwordMatch');

        if (confirmPassword.length === 0) {
            feedback.text("");
            return;
        }

        if (password !== confirmPassword) {
            feedback.text("Passwords do not match ‚ùå").css("color", "red");
        } 
        else {
            feedback.text("Passwords match ‚úî").css("color", "green");
        }
    });








    $('#studentRegisterForm').on('submit', function(e) {
      e.preventDefault();

      let pass = $('#password').val();
      let confirmPass = $('#confirmPassword').val();

      let hasLetter = /[a-zA-Z]/.test(pass);
      let hasNumber = /\d/.test(pass);

      // --- Client-side validation ---
      if (pass !== confirmPass) {
          Swal.fire({
              icon: 'error',
              title: 'Password Mismatch',
              text: 'Passwords do not match!'
          });
          return;
      }

      if (pass.length < 6 || !hasLetter || !hasNumber) {
          Swal.fire({
              icon: 'error',
              title: 'Weak Password',
              text: 'Password must be at least 6 characters and contain both letters and numbers.'
          });
          return;
      }

      // Show loader
      Swal.fire({
          title: 'Processing...',
          text: 'Please wait while we register the student.',
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading()
      });

      const formData = {
          _token: $('input[name="_token"]').val(),
          name: $('#fullName').val(),
          reg_no: $('#regNo').val(),
          username: $('#username').val(),
          email: $('#email').val(),
          password: pass,
          confirm_password: confirmPass,
      };

      $.ajaxSetup({
          headers: {
              'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
          }
      });

      $.ajax({
          url: '/student/register',
          type: 'POST',
          data: formData,

          success: function(res) {
            Swal.fire({
                icon: 'success',
                title: 'Student Registered!',
                text: res.message,
                timer: 5000,
                showConfirmButton: true
            });

            $('#studentRegisterForm')[0].reset();
            $('#passwordStrength').text("");
            $('#passwordMatch').text("");

            // Redirect to dashboard
            setTimeout(() => {
                window.location.href = '/student-dashboard';
            }, 1500);
          },

          error: function(xhr) {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: xhr.responseJSON?.message || "An unexpected error occurred",
              timer: 5000,
              showConfirmButton: true
            });
          }
      });
    });
  }









  if(window.location.pathname === '/student-login'){
    $('#studentLoginForm').on('submit', function(e) {
      e.preventDefault();

      let email = $('#email').val();
      let password = $('#password').val();

      // Basic validation
      if (!email || !password) {
        Swal.fire({
          icon: 'error',
          title: 'Missing Fields',
          text: 'Please enter email and password.'
        });
        return;
      }

      // Loader
      Swal.fire({
        title: 'Logging in...',
        text: 'Please wait.',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      $.ajaxSetup({
        headers: {
          'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
        }
      });

      $.ajax({
        url: '/student/login',
        type: 'POST',
        data: {
          email: email,
          password: password
        },

        success: function(res) {
          Swal.fire({
            icon: 'success',
            title: 'Login Successful',
            text: res.message || 'Welcome back!',
            timer: 3000,
            showConfirmButton: true
          });

          // Redirect to dashboard
          setTimeout(() => {
            window.location.href = '/student-dashboard';
          }, 1500);
        },

        error: function(xhr) {
          Swal.fire({
            icon: "error",
            title: "Login Failed",
            text: xhr.responseJSON?.message || "Invalid login details.",
            timer: 5000,
            showConfirmButton: true
          });
        }
      });
    });
  }







  if (
    window.location.pathname === "/student-dashboard/check-result" ||
    window.location.pathname === "/student-dashboard"
  ) {
      $("#resultCheckForm").on("submit", function (e) {
          e.preventDefault();

          let data = {
              reg_no: $("#reg_no").val(),
              name: $("#name").val(),
              class: $("#class").val(),
              semester: $("#semester").val(),
              password: $("#password").val(),
              _token: $('input[name="_token"]').val(),
          };

          Swal.fire({
              title: "Checking...",
              text: "Fetching result, please wait.",
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading(),
          });

          $.ajax({
              url: "/student-dashboard/check-result",
              type: "POST",
              data: data,
              success: function (response) {
                  Swal.close();

                  // Result HTML
                  $("#resultDisplay").html(`
                    <div id="resultCard" class="p-3 shadow bg-white rounded">
                      <h4 class="text-center mb-4">Cornelia Connelly college Rd Nise Anambra, Nigeria</h4>                      
                      <h5 class="mb-3 text-primary">Result for ${response.name}</h5>

                      <p><strong>Reg No:</strong> ${response.reg_no}</p>
                      <p><strong>Class:</strong> ${response.class}</p>
                      <p><strong>Semester:</strong> ${response.semester}</p>

                      <hr>

                      <p><strong>Total points:</strong> ${response.total_point}</p>
                      <p><strong>Average:</strong> ${response.average}</p>
                      <p><strong>Position:</strong> ${response.position}</p>
                      <p><strong>Remarks:</strong> ${response.remarks}</p>
                      <p><strong>Session:</strong> ${response.session}</p>

                      <hr>

                      <div class="mt-3 text-center">
                          <button id="btnScreenshot" class="btn btn-sm btn-success me-2">Download Screenshot</button>
                          <button id="btnPrint" class="btn btn-sm btn-primary">Print Result</button>
                      </div>
                    </div>
                  `);

                  // --- Screenshot button logic ---
                  $("#btnScreenshot").on("click", function () {
                      let resultCard = document.getElementById("resultCard");

                      html2canvas(resultCard).then((canvas) => {
                          let link = document.createElement("a");
                          link.download = `${response.reg_no}_result.png`;
                          link.href = canvas.toDataURL("image/png");
                          link.click();
                      });
                  });

                  // --- Print button logic ---
                  $("#btnPrint").on("click", function () {
                      let printContent = document.getElementById("resultCard").innerHTML;
                      let win = window.open("", "PRINT", "height=600,width=800");

                      win.document.write(`
                          <html>
                              <head>
                                  <title>Print Result</title>
                                  <style>
                                      body { font-family: Arial, sans-serif; padding: 20px; }
                                      h5 { color: #0056b3; }
                                  </style>
                              </head>
                              <body>${printContent}</body>
                          </html>
                      `);

                      win.document.close();
                      win.focus();
                      win.print();
                  });
              },

              error: function (xhr) {
                  Swal.fire({
                      icon: "error",
                      title: "Error",
                      text: xhr.responseJSON?.message || "Result not found.",
                      timer: 4000,
                  });
              },
          });
      });
  }














  // Student edit account JavaScript codes
  if (window.location.pathname === '/student-dashboard/edit-student') {

    // Fetch current student data
    $.ajax({
        url: "/student-dashboard/fetch-account",
        type: "GET",

        success: function(res) {
            $("#edit_fullName").val(res.name);
            $("#edit_regNo").val(res.reg_no);
            $("#edit_username").val(res.username);
            $("#edit_email").val(res.email);
        },

        // error: function() {
        //     Swal.fire({
        //         icon: 'error',
        //         title: 'Session Expired',
        //         text: 'Please login again.'
        //     });

        //     setTimeout(() => {
        //         window.location.href = '/student-login';
        //     }, 2000);
        // }
    });
  }






  // Update the account
  $('#editStudentForm').on('submit', function(e) {
        e.preventDefault();

        // Get form data
        let name = $('#edit_fullName').val();
        let reg_no = $('#edit_regNo').val();
        let username = $('#edit_username').val();
        let email = $('#edit_email').val();

        // Validation
        if (!name || !reg_no || !username || !email) {
            Swal.fire({
                icon: 'error',
                title: 'Missing Fields',
                text: 'All fields are required.'
            });
            return;
        }

        // Loader
        Swal.fire({
            title: 'Updating...',
            text: 'Please wait.',
            allowOutsideClick: false,
            didOpen: () => Swal.showLoading()
        });

        $.ajaxSetup({
            headers: {
                "X-CSRF-TOKEN": $('meta[name="csrf-token"]').attr("content")
            }
        });

        $.ajax({
            url: "/student-dashboard/update-account",
            type: "POST",
            data: {
                name: name,
                reg_no: reg_no,
                username: username,
                email: email,
            },

            success: function(res) {
                Swal.fire({
                    icon: 'success',
                    title: 'Updated!',
                    text: res.message,
                    timer: 2000,
                    showConfirmButton: true
                });
            },

            error: function(xhr) {
                Swal.fire({
                    icon: 'error',
                    title: 'Update Failed',
                    text: xhr.responseJSON?.message || 'Something went wrong.'
                });
            }
        });
    });

});













// Login page JavaScript codes
$(document).ready(function () {
    if(window.location.pathname === '/admin-login'){
        // Set CSRF token for all AJAX requests
        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $('#loginForm').submit(function (e) {
            e.preventDefault();

            const username = $('#username').val();
            const password = $('#password').val();

            // Show loading spinner before AJAX request
            Swal.fire({
                title: 'Logging in...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading(); // shows spinner
                }
            });

            $.ajax({
                type: 'POST',
                url: '/admin/login',
                data: { username, password },
                success: function (response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: response.message || 'Login successful!',
                        timer: 1000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = '/dashboard';
                    });
                },
                error: function (xhr) {
                    const errorMessage = xhr.responseJSON?.message || 'Invalid credentials';
                    Swal.fire({
                        icon: 'error',
                        title: 'Login Failed',
                        text: errorMessage
                    });
                }
            });
        });
    }
});











// Blog page JavaScript code
$(document).ready(function () {

  if(window.location.pathname === '/dashboard/blog') {
    // Preview selected new image
    $('#blogImage').on('change', function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = e => {
          $('#previewImage').attr('src', e.target.result).show();
        };
        reader.readAsDataURL(file);
      } else {
        $('#previewImage').hide();
      }
    });

    // Create post with image
    $('#blogForm').submit(function (e) {
        e.preventDefault();
        if (createBlogEditor) {
          $('#blogMessage').val(createBlogEditor.getData());
        }
        const formEl = this;
        const fd = new FormData(formEl);

        // ‚úÖ Show loading spinner before AJAX request
        Swal.fire({
          title: 'Creating Blog...',
          text: 'Please wait ...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading(); // shows spinner
          }
        });

        // Set CSRF token for all AJAX requests
        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.ajax({
            url: '/blog/createBlog',
            type: 'POST',
            data: fd,
            processData: false,
            contentType: false,
            success(res) {
                $(formEl)[0].reset();
                $('#previewImage').hide();
                fetchBlogs();
                Swal.fire({
                    icon: 'success',
                    title: 'Created!',
                    text: res.message || 'Blog post created successfully.'
                });
            },
            error(err) {
                console.error(err);
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: err.responseJSON?.message || 'Error creating blog'
                });
            }
        });
    });






    // Fetch blogs with pagination
    function renderPagination(current, total, callback) {
      const container = $('#paginationControls');
      container.empty();

      if (total <= 1) return;

      const createButton = (pageNum, isActive = false) => {
        const btn = $(`<button class="btn btn-sm ${isActive ? 'btn-primary' : 'btn-outline-primary'} mx-1">${pageNum}</button>`);
        btn.on('click', () => callback(pageNum)); // üëà Use callback
        return btn;
      };

      const addEllipsis = () => {
        container.append('<span class="mx-2">...</span>');
      };

      if (current > 1) container.append(createButton(current - 1).text('¬´ Prev'));
      container.append(createButton(1, current === 1));

      if (current > 3) addEllipsis();

      for (let i = current - 1; i <= current + 1; i++) {
        if (i > 1 && i < total) {
          container.append(createButton(i, i === current));
        }
      }

      if (current < total - 2) addEllipsis();

      container.append(createButton(total, current === total));
      if (current < total) container.append(createButton(current + 1).text('Next ¬ª'));
    }

    const itemsPerPage = 5;

    function fetchBlogs(page = 1) {
      $.get(`/blog/getAllBlogs?page=${page}&limit=${itemsPerPage}`, function (res) {
        const blogs = res.data || [];
        const totalPages = res.totalPages || 1;
        const currentPage = res.currentPage || 1;
        let html = '';

        if (blogs.length === 0) {
          html = `
            <div class="col-12">
              <div class="alert alert-info text-center" role="alert">
                No blogs available yet.
              </div>
            </div>
          `;
        } else {
          html = blogs.map(blog => {
            const shortMessage = blog.message.length > 50 ? blog.message.substring(0, 50) + '...' : blog.message;

            return `
              <div class="d-flex flex-row comment-row border-bottom p-3 gap-3">
                <div>
                  ${blog.image
                    ? `<img src="/${blog.image}" class="rounded-circle" width="50" height="50" />`
                    : `<i class="ti ti-camera fs-2"></i>`
                  }
                </div>
                <div class="comment-text w-100">
                  <h6 class="fw-medium">${blog.title}</h6>
                  <p class="mb-1 fs-2 text-muted">${shortMessage}</p>
                  <div class="comment-footer mt-2 d-flex justify-content-between align-items-center">
                    <div>
                      <a href="javascript:void(0)" class="ps-3 text-primary edit-blog-btn" data-id="${blog.id}">
                        <i class="ti ti-edit fs-5"></i>
                      </a>
                      <a href="javascript:void(0)" class="ps-3 text-danger delete-btn" data-id="${blog.id}">
                        <i class="ti ti-trash fs-5"></i>
                      </a>
                    </div>
                    <span class="text-muted fw-normal fs-2">${new Date(blog.createdAt).toDateString()}</span>
                  </div>
                </div>
              </div>
            `;
          }).join('');
        }

        $('#blogList').html(html);
        renderPagination(currentPage, totalPages, fetchBlogs);
      });
    }

    fetchBlogs();



    // Open Edit Modal and preload data
    $(document).on('click', '.edit-blog-btn', function () {
      const id = $(this).data('id');
      $.get(`/blog/getSingleBlog/${id}`, function (blog) {
        $('#editId').val(blog.id);
        $('#editTitle').val(blog.title);
        // Load description into CKEditor
        if (editBlogEditor) {
          editBlogEditor.setData(blog.message || '');
        } else {
          // Fallback if editor not initialized yet
          $('#editMessage').val(blog.message || '');
        }

        if (blog.image) {
          $('#currentImage').attr('src', '/' + blog.image).show();
        } else {
          $('#currentImage').hide();
        }
        $('#previewEditImage').hide().attr('src', '');
        $('#editImage').val('');
        $('#editBlogModal').modal('show');
      });
    });


    // Preview the selected image in the edit modal
    $('#editImage').on('change', function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          $('#previewEditImage')
            .attr('src', e.target.result)
            .show();
        };
        reader.readAsDataURL(file);
      } else {
        $('#previewEditImage').hide();
      }
    });

    // Preview selected new image
    $('#editForm').submit(function (e) {
      e.preventDefault();

      if (editBlogEditor) {
        $('#editMessage').val(editBlogEditor.getData());
      }
      const id = $('#editId').val();
      const fd = new FormData(this);

      // ‚úÖ Show loading spinner before AJAX request
      Swal.fire({
        title: 'Updating Blog...',
        text: 'Please wait ...',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading(); // shows spinner
        }
      });

      $.ajax({
        url: `/blog/updateSingleBlog/${id}`,
        type: 'POST',
        data: fd,
        processData: false,
        contentType: false,
        success() {
          $('#editBlogModal').modal('hide');
          fetchBlogs();
          Swal.fire({
              icon: 'success',
              title: 'Updated!',
              text: 'Blog post updated successfully.'
          });
        },
        error(err) {
          console.error(err);
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: err.responseJSON?.message || 'Error updating blog'
          });
        }
      });
    });

    // Delete blog
    $(document).on('click', '.delete-btn', function () {
      const id = $(this).data('id');
      Swal.fire({
          title: 'Are you sure?',
          text: "This will permanently delete the post.",
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#3085d6',
          confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          // ‚úÖ Show loading spinner before AJAX request
          Swal.fire({
            title: 'Deleting Blog...',
            text: 'Please wait ...',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading(); // shows spinner
            }
          });

          $.ajaxSetup({
              headers: {
                  'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
              }
          }); 


          $.post(`/blog/deleteSingleBlog/${id}`, function () {
            fetchBlogs();
            Swal.fire(
              'Deleted!',
              'Your blog post has been deleted.',
              'success'
            );
          });
        }
      });
    });
  }
});

















$(() => {
  // üåü GLOBAL AJAX LOADING INDICATOR + AUTO RESPONSE ALERT üåü

  // Show loader when any AJAX request starts
  // $(document).ajaxStart(function () {
  //     Swal.fire({
  //         title: "Please wait...",
  //         text: "Processing request",
  //         allowOutsideClick: false,
  //         allowEscapeKey: false,
  //         didOpen: () => Swal.showLoading()
  //     });
  // });

  // Hide loader + show backend message automatically
  // $(document).ajaxStop(function () {
  //     Swal.close(); // close the loading spinner
  // });

  // GLOBAL AJAX SUCCESS HANDLER
  // $(document).ajaxSuccess(function (event, xhr) {
  //     try {
  //         const res = xhr.responseJSON;
  //         if (res && res.message) {
  //             Swal.fire({
  //               icon: res.status ? "success" : "info",
  //               text: res.message,
  //               timer: 2000,
  //               showConfirmButton: false
  //             });
  //         }
  //     } catch (e) {
  //         // ignore json parse errors
  //     }
  // });

  // GLOBAL AJAX ERROR HANDLER
  // $(document).ajaxError(function (event, xhr) {
  //   Swal.fire({
  //       icon: "error",
  //       title: "Error",
  //       text: xhr.responseJSON?.message || "An unexpected error occurred",
  //       timer: 5000,
  //       showConfirmButton: false
  //   });
  // });

  // Create student record page JavaScript code
  if(window.location.pathname === '/dashboard/create') {
    $('#createStudentForm').on('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            _token: $('input[name="_token"]').val(),
            serialNumber: $('#serialNumber').val(),
            name: $('#studentName').val(),
            reg_no: $('#studentRegNo').val(),
            class: $('#studentClass').val(),
            semester: $('#studentSemester').val(),
            session: $('#studentSession').val(),
            total: $('#studentTotal').val(),
            average: $('#studentAverage').val(),
            position: $('#studentPosition').val(),
            remarks: $('#studentRemarks').val()
        };

        $.ajax({
          url: '/scores/create',
          type: 'POST',
          data: formData,
          success: function(res) {
              Swal.fire({
                  icon: 'success',
                  title: 'Success!',
                  text: res.message || 'Student\'s record created successfully',
                  timer: 5000,
                  showConfirmButton: false
              });
              $('#createStudentForm')[0].reset();
          },
          error: function(xhr) {
            Swal.fire({
              icon: "error",
              title: "Error",
              text: xhr.responseJSON?.message || "An unexpected error occurred",
              timer: 5000,
              showConfirmButton: false
          });
              console.error(err);
          },
          complete: function() {
              $('#createStudentBtn').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Create Student');
          }
        });

    });
  }















  // Upload result as CSV page JavaScript code
  const isUploadPage = window.location.pathname === '/dashboard/upload';
  const csrfToken = $('meta[name="csrf-token"]').attr('content');

  // Reusable SweetAlert
  const notify = (icon, title, text) => {
      Swal.fire({ icon, title, text });
  };

  // AJAX setup for CSRF
  $.ajaxSetup({
      headers: { 'X-CSRF-TOKEN': csrfToken }
  });


  // -----------------------------
  // 1Ô∏è‚É£ FILE VALIDATION HANDLER
  // -----------------------------
  function handleFileSelect(input) {
      const file = input.files[0];
      if (!file) return;

      const allowedTypes = [
          'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
          'application/vnd.ms-excel'
      ];

      if (!allowedTypes.includes(file.type)) {
          notify('error', 'Invalid File', 'Please upload a valid Excel file (.xlsx or .xls)');
          $(input).val('');
          return;
      }

      notify('success', 'File Selected', 'Excel file ready for upload');
  }


  // -----------------------------
  // 2Ô∏è‚É£ UPLOAD EXCEL FUNCTION
  // -----------------------------
  function uploadExcel(form) {
    const formData = new FormData(form);

    Swal.fire({
      title: 'Uploading Excel...',
      text: 'Please wait...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    $.post({
      url: '/scores/upload',
      data: formData,
      processData: false,
      contentType: false,
      success: () => {
        form.reset();
        notify('success', 'Imported!', 'Excel file imported successfully.');
        fetchScores();
      },
      error: (err) => {
        console.error(err);
        notify('error', 'Upload Failed', err.responseJSON?.message || 'Failed to upload Excel file');
      }
    });
  }


  // -----------------------------
  // 3Ô∏è‚É£ FETCH UPLOADED SCORES
  // -----------------------------
  function fetchScores(page = 1) {
      $.get(`/scores/list?page=${page}`, (res) => {
          const data = res.data || [];
          let html = '';

          if (data.length === 0) {
              html = `
                  <div class="alert alert-info text-center">
                      No scores uploaded yet.
                  </div>
              `;
          } else {
              html = data.map(row => `
                  <div class="d-flex flex-column border-bottom p-3">
                      <div class="fw-bold">${row.name}</div>
                      <div class="text-muted">Reg No: ${row.reg_no}</div>
                      <div class="text-muted">Total: ${row.total}</div>
                  </div>
              `).join('');
          }

          $('#csvRecordList').html(html);
      });
  }


  // -----------------------------
  // 4Ô∏è‚É£ PAGINATION RENDER (Reusable)
  // -----------------------------
  function renderPagination(current, total, callback) {
      const container = $('#csvPaginationControls');
      container.empty();

      if (total <= 1) return;

      const createBtn = (page, active = false, label = null) => {
          const btn = $(`<button class="btn btn-sm ${active ? 'btn-primary' : 'btn-outline-primary'} mx-1">${label || page}</button>`);
          btn.on('click', () => callback(page));
          return btn;
      };

      // Prev
      if (current > 1) container.append(createBtn(current - 1, false, '¬´ Prev'));

      // First page
      container.append(createBtn(1, current === 1));

      if (current > 3) container.append('<span class="mx-2">...</span>');

      // Middle pages
      for (let i = current - 1; i <= current + 1; i++) {
          if (i > 1 && i < total) container.append(createBtn(i, i === current));
      }

      if (current < total - 2) container.append('<span class="mx-2">...</span>');

      // Last page
      container.append(createBtn(total, current === total));

      // Next
      if (current < total) container.append(createBtn(current + 1, false, 'Next ¬ª'));
  }


  // -----------------------------
  // 5Ô∏è‚É£ FETCH CSV RECORDS (OLD SYSTEM)
  // -----------------------------
  const csvItemsPerPage = 10;

  function fetchCSVRecords(page = 1) {
      $.get(`/csv/getRecords?page=${page}&limit=${csvItemsPerPage}`, (res) => {
          const data = res.data || [];
          const totalPages = res.totalPages || 1;
          const currentPage = res.currentPage || 1;

          let html = data.length
              ? data.map(row => `
                  <div class="d-flex flex-column border-bottom p-3">
                      <div class="fw-bold">${row.field1}</div>
                      <div class="text-muted">${row.field2}</div>
                      <div class="text-muted">${row.field3}</div>
                  </div>
              `).join('')
              : `
                  <div class="alert alert-info text-center">
                      No CSV records uploaded yet.
                  </div>
              `;

          $('#csvRecordList').html(html);
          renderPagination(currentPage, totalPages, fetchCSVRecords);
      });
  }


  // -----------------------------
  // 6Ô∏è‚É£ EVENT BINDINGS (ONLY ON UPLOAD PAGE)
  // -----------------------------
  if (isUploadPage) {

      // File selection handler
      $('#excelFile').on('change', function () {
          handleFileSelect(this);
      });

      // Excel upload handler
      $('#excelUploadForm').on('submit', function (e) {
          e.preventDefault();
          uploadExcel(this);
      });

      // Initial load
      fetchScores();
  }













    if (window.location.pathname === '/dashboard/list') {
      const csrfToken = $('meta[name="csrf-token"]').attr('content');
      $.ajaxSetup({ headers: { 'X-CSRF-TOKEN': csrfToken } });

      function fetchScores(page = 1) {
        const filters = {
            page,
            class: $('#filterClass').val(),
            semester: $('#filterSemester').val(),
            session: $('#filterSession').val(),
            search: $('#searchKeyword').val()
        };

        // -------------------------------------
        // PAGINATION RENDER (Reusable Function)
        // -------------------------------------
        function renderPagination(current, total, callback) {
            const container = $('#scoresPagination'); // FIXED ID
            container.empty();

            if (total <= 1) return;

            const createBtn = (page, active = false, label = null) => {
                const btn = $(`
                    <button class="btn btn-sm ${active ? 'btn-primary' : 'btn-outline-primary'} mx-1">
                        ${label || page}
                    </button>
                `);
                btn.on('click', () => callback(page));
                return btn;
            };

            // Prev
            if (current > 1) container.append(createBtn(current - 1, false, '¬´ Prev'));

            // First Page
            container.append(createBtn(1, current === 1));

            if (current > 3) container.append('<span class="mx-2">...</span>');

            // Middle pages
            for (let i = current - 1; i <= current + 1; i++) {
                if (i > 1 && i < total) container.append(createBtn(i, i === current));
            }

            if (current < total - 2) container.append('<span class="mx-2">...</span>');

            // Last page
            container.append(createBtn(total, current === total));

            // Next
            if (current < total) container.append(createBtn(current + 1, false, 'Next ¬ª'));
        }


        // Fetch API
        Swal.fire({
          title: "Please wait...",
          text: "Processing request",
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => Swal.showLoading()
        });

        $.get('/scores/list', filters, function(res) {

          const data = res.data || [];
          const totalPages = res.totalPages || 1;
          const currentPage = res.currentPage || 1;

          let html = '';

          if (data.length === 0) {
              html = `
                  <tr>
                      <td colspan="12" class="text-center text-danger fw-bold">
                          No record found.
                      </td>
                  </tr>
              `;
          } else {
            data.forEach(row => {
              html += `
                <tr>
                  <td><input type="checkbox" class="rowSelect" data-id="${row.id}"></td>
                  <td>${row.s_no || ''}</td>
                  <td>${row.name || ''}</td>
                  <td>${row.reg_no || ''}</td>
                  <td>${row.class || ''}</td>
                  <td>${row.semester || ''}</td>
                  <td>${row.session || ''}</td>
                  <td>${row.total || ''}</td>
                  <td>${row.average || ''}</td>
                  <td>${row.position || ''}</td>
                  <td>${row.remarks || ''}</td>
                  <td class="text-center">
                      <i class="bi bi-pencil-square text-primary fs-5 editBtn" style="cursor:pointer;" data-id="${row.id}"></i>
                      &nbsp;&nbsp;
                      <i class="bi bi-trash3 text-danger fs-5 deleteBtn" style="cursor:pointer;" data-id="${row.id}"></i>
                  </td>
                </tr>
              `;
            });
          }

          $('#scoresTableBody').html(html);

          // Call pagination
          renderPagination(currentPage, totalPages, fetchScores);

          // ‚úÖ Close loading Swal when done
          Swal.close();
      })
    }

      // Filters ‚Äî ALWAYS reload page 1
      $('#filterBtn').on('click', () => fetchScores(1));
      $('#filterSession, #searchKeyword').on('keyup', e => {
          if (e.key === 'Enter') fetchScores(1);
      });

      // Select All
      $('#selectAll').on('change', function() {
          $('.rowSelect').prop('checked', this.checked);
      });

      // Bulk Delete
      $('#bulkDeleteBtn').on('click', function() {
          const ids = $('.rowSelect:checked').map(function(){ return $(this).data('id'); }).get();
          if (ids.length === 0) return Swal.fire('Select records first!');
          
          Swal.fire({
              title: 'Are you sure?',
              text: `Delete ${ids.length} selected records?`,
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: 'Yes, delete'
          }).then(result => {
              if(result.isConfirmed) {
                  $.post('/scores/bulk-delete', { ids }, () => fetchScores(1));
              }
          });
      });

      // Edit Modal
      $(document).on('click', '.editBtn', function() {
          const id = $(this).data('id');
          $.get(`/scores/getSingle/${id}`, function(data) {
            console.log(data);
              $('#editScoreId').val(data.data.id);
              $('#editName').val(data.data.name);
              $('#editRegNo').val(data.data.reg_no);
              $('#editClass').val(data.data.class);
              $('#editSemester').val(data.data.semester);
              $('#editSession').val(data.data.session);
              $('#editTotal').val(data.data.total);
              $('#editAverage').val(data.data.average);
              $('#editPosition').val(data.data.position);
              $('#editRemarks').val(data.data.remarks);
              $('#editScoreModal').modal('show');
          });

          // Hide modal onclose
          $('.close-modal').on('click', function() {
              $('#editScoreModal').modal('hide');
          });
      });

      $('#saveEditBtn').on('click', function() {
          const id = $('#editScoreId').val();
          const payload = {
              name: $('#editName').val(),
              reg_no: $('#editRegNo').val(),
              class: $('#editClass').val(),
              semester: $('#editSemester').val(),
              session: $('#editSession').val(),
              total: $('#editTotal').val(),
              average: $('#editAverage').val(),
              position: $('#editPosition').val(),
              remarks: $('#editRemarks').val()
          };

          $.ajax({
              url: `/scores/updateSingle/${id}`,
              type: 'PATCH',
              data: payload,
              success: () => { 
                  $('#editScoreModal').modal('hide'); 
                  fetchScores(1); 
              }
          });
      });

      // Delete single
      $(document).on('click', '.deleteBtn', function() {
          const id = $(this).data('id');
          
          Swal.fire({
              title: 'Confirm Delete',
              text: "This record will be permanently removed!",
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: 'Delete'
          }).then(result => {
              if(result.isConfirmed) {
                  $.ajax({
                      url: `/scores/deleteSingle/${id}`,
                      type: 'DELETE',
                      success: () => fetchScores(1)
                  });
              }
          });
      });

      fetchScores();
  }
});



















  // Change password page Javascript codes 
  
  $(function() {
    // Student change password page JavaScript codes
    if(window.location.pathname === '/student-dashboard/change-password') {
      // Toggle show/hide password
      $('.toggle-password').on('click', function() {
          const input = $($(this).data('target'));
          const icon = $(this).find('i');

          if (input.attr('type') === 'password') {
              input.attr('type', 'text');
              icon.removeClass('ti-eye').addClass('ti-eye-off');
          } else {
              input.attr('type', 'password');
              icon.removeClass('ti-eye-off').addClass('ti-eye');
          }
      });

      // Submit password update
      $('#studentChangePasswordForm').on('submit', function(e) {
          e.preventDefault();

          const currentPass = $('#studentCurrentPassword').val().trim();
          const newPass = $('#studentNewPassword').val().trim();

          // Password rule: min 6 chars, must contain letters + numbers
          const isValidPassword = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/;

          if (!newPass || !currentPass) {
              Swal.fire({
                  icon: 'warning',
                  text: 'Both current and new password fields are required.'
              });
              return;
          }

          if (!isValidPassword.test(newPass)) {
              Swal.fire({
                  icon: 'warning',
                  title: 'Invalid Password',
                  text: 'Password must be at least 6 characters and contain letters and numbers.'
              });
              return;
          }

          // AJAX request
          $.ajax({
              url: '/student-dashboard/update-password',
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({
                  currentPassword: currentPass,
                  newPassword: newPass
              }),
              beforeSend() {
                  Swal.fire({
                      title: 'Updating Password...',
                      allowOutsideClick: false,
                      didOpen: () => Swal.showLoading()
                  });
              },
              success(res) {
                  Swal.fire({
                      icon: 'success',
                      title: 'Success',
                      text: res.message || 'Password updated successfully!'
                  });

                  $('#studentCurrentPassword').val('');
                  $('#studentNewPassword').val('');
              },
              error(xhr) {
                  Swal.fire({
                      icon: 'error',
                      title: 'Error',
                      text: xhr.responseJSON?.message || 'An error occurred. Please try again.'
                  });
              }
          });
      });
    }





    // Admin change password page JavaScript codes
    if(window.location.pathname === '/dashboard/change-password') {
      $('.toggle-password').on('click', function() {
        const input = $($(this).data('target'));
        const icon = $(this).find('i');

        if (input.attr('type') === 'password') {
            input.attr('type', 'text');
            icon.removeClass('ti-eye').addClass('ti-eye-off');
        } else {
            input.attr('type', 'password');
            icon.removeClass('ti-eye-off').addClass('ti-eye');
        }
      });

      $('#changePasswordForm').on('submit', function(e) {
        e.preventDefault();

        const currentPass = $('#currentPassword').val().trim();
        const newPass = $('#newPassword').val().trim();

        // üö® VALIDATION: must be 6+ chars, contain letters + numbers
        const isValidPassword = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/;

        if (!newPass || !currentPass) {
          Swal.fire({
            icon: 'warning',
            text: 'Both current and new password fields are required.'
          });
          return;
        }

        if (!isValidPassword.test(newPass)) {
          Swal.fire({
            icon: 'warning',
            title: 'Invalid Password',
            text: 'Password must be at least 6 characters and contain both letters and numbers.'
          });
          return;
        }

        // If validation passed ‚Üí continue with AJAX
        $.ajax({
          url: '/admin/update-password',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ currentPassword: currentPass, newPassword: newPass }),
          beforeSend() {
            Swal.fire({
              title: 'Updating Password...',
              allowOutsideClick: false,
              didOpen: () => Swal.showLoading()
            });
          },
          success(res) {
            Swal.fire({
              icon: 'success',
              title: 'Success',
              text: res.message || 'Password changed successfully!'
            });
            $('#newPassword').val('');
          },
          error(xhr) {
            console.log(xhr.responseJSON);
            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: xhr.responseJSON?.message || 'An error occurred. Please try again.'
            });
          }
        });
      });
    }
  });

});













// Logout JavaScript codes for both admin and student
$(() => {
  $('.logout-btn').on('click', function (e) {
    e.preventDefault();

    Swal.fire({
      title: 'Are you sure?',
      text: "You will be logged out of your account.",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, logout'
    }).then((result) => {
      if (result.isConfirmed) {

        // ‚úÖ Show loading spinner before AJAX request
        Swal.fire({
          title: 'Logging Out...',
          text: 'Please wait ...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading(); // shows spinner
          }
        });

        $.ajax({
          type: 'POST',
          url: '/logout',
          success: function (response) {
            Swal.fire({
              icon: 'success',
              title: 'Logged out',
              text: response.message,
              timer: 1000,
              showConfirmButton: false
            }).then(() => {
              window.location.href = response.redirect;
            });
          },
          error: function (xhr) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: xhr.responseJSON?.message || 'An error occured while logging out.'
            });
          }
        });
      }
    });
  });
});
